name: Flask API CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t mindease_model .

      - name: Start container
        run: |
          docker run -d -p 5000:5000 --name mindease_api mindease_model
          echo "Container started, checking status..."
          docker ps -a | grep mindease_api
          echo "Container logs (first 50 lines):"
          sleep 3
          docker logs mindease_api | head -50 || true
          # Wait for app to start
          for i in {1..10}; do
            echo "Attempt $i: Checking if app is responding..."
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 2 http://localhost:5000 2>&1 || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "App is up! (HTTP $HTTP_CODE)"
              break
            else
              echo "Waiting for app... (HTTP code: $HTTP_CODE, curl exit: $?)"
              echo "Recent container logs:"
              docker logs --tail 20 mindease_api 2>&1 || true
            fi
            if [ $i -eq 10 ]; then
              echo "ERROR: App did not start after 20 seconds"
              echo "Full container logs:"
              docker logs mindease_api 2>&1 || true
              exit 1
            fi
            sleep 2
          done
          echo "Final container status:"
          docker ps -a | grep mindease_api
          echo "Final container logs:"
          docker logs mindease_api || true

      - name: Run tests inside container
        run: |
          echo "Checking container status before tests..."
          docker ps -a | grep mindease_api
          echo "Checking if app is accessible from inside container..."
          docker exec mindease_api python -c "import requests; r = requests.get('http://localhost:5000', timeout=2); print(f'Status: {r.status_code}')" || echo "App not accessible from inside container"
          echo "Running tests..."
          docker exec mindease_api python test.py

      - name: Stop container
        if: always()
        run: |
          echo "Collecting final logs before cleanup..."
          docker logs mindease_api 2>&1 || true
          docker stop mindease_api || true
          docker rm mindease_api || true
 